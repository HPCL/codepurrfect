# INSTRUCTIONS FOR ADDING A NEW CLANG BASED CHECKS 
--- 

## **Writing the tool** 

There are three types of passes one can write based on 
the *clang/llvm* infrastructure. The pass is either 
one that observes the action of the preprocessor, 
one that traverses the AST, or one that works on the 
intermediate representation. Inside the directory 
`src/static`, these correspond to the directories: 
  - passes-pp
  - passes-ast 
  - passes-ir 







respectively. Consequently, to add a check, first decide 
which type of pass it is based on. 

For example, the pass that checks for any circular dependecies between modules `includes-cyles`, is based on the c++ source code in `src/static/passes-pp/includes-cycles`. 

Next, add a `CMakeLists.txt` file in the directory to specify how to build the pass. 

Once the pass has been built, and the location of the executable (i.e *the tool*) is known, modify `src/static/driver/myglobals.py` to make the location of the tool known 
to the system.

For example, assigning a string value to `myglobals.config_vars["pp"]["includes-cycles"]` specifies the string as the path for the `includes-cycles` tool.

## **Running the Tool** 

Running `/src/static/driver/main.py` with the `--init` flag creates the directory necessary for holding the files potentially created by the pass/tool. The function `handleInitWithPasses` of `initializer.py` performs this action; with the help of an object of type `PassRunner` defined in `passRunner.py`. This is the object that `run`s (generates temp files as dictated by the check/pass/tool) and `post_process`es (move and group the temp files into appropriate directories) the passes. *No further action is needed from a developer who wants to add an AST or PP pass concerning the `--init` flag. The current machinery will generate and group the necessary files in `.ideas-uo/<projectname>-[ast|pp]-metrics/<passname>`. All they need to do is to provide either the `--ast_pass` or `--pp_pass` flag with the appropriate value. E.g initializing the system with 
the `includes-cycles` pass, involves calling `/static/driver/main.py --init --pp_pass="includes-cycles"`. If more than one `ast` pass or `pp` pass are run together, separate them with commas in the string passed to the flag.* 

The `--report` flag handles the displaying of the output to the user after the check's flag is specified. For example `/static/driver/main.py --report --ast_pass='switch-no-default'` will print the location of each switch clause without a default statement. This action is performed by 
the `handleReport` function defined in `main.py`; with the help of an object of type `Reporter` defined in `metricThresholds.py`. 

Inside `metricThresholds.py`, modify `import_data` to specify how the data generated by the pass 
is to be processed by the `Reporter` before displaying the result to the user. For example, `import_data` builds a `networkx` graph and calculates all the simple cycles in it, when the `includes-cycles` pass is specified, so that when `report_sorted` is called, the identified cycles 
can be printed.


An IR pass might involve declaring a new flag in `main.py`. In which case, one first needs to modify the `CmdArgsTy` data type, before they modify `parseCmdArgsTy`. 

  

If the pass involves the calculation of metric thresholds, the methods `calc_metric_thresholds`, `sort_data`, and `fit_get_thresholds` defined in `metricThresholds.py` might need to be adjusted. 

Once all these pieces are in place, call `/static/driver/main.py` with the appropriate flags inside a directory containing a `compile_commands.json` file with an item to help compile each file in a given project, first to initialize the system, and then to generate reports.